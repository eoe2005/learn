# 服务网关选择

## 服务网关备选

1. Kong  https://konghq.com/products/kong-enterprise/kong-kubernetes/
2. GoKu https://www.eolinker.com/product/api_gateway/

## 服务网关比较

|   功能   |                             Kong                             |    GoKu(开源版本)     |
| :------: | :----------------------------------------------------------: | :-------------------: |
|   认证   | Basic Auth，Key Auth,Oauth2,Hmac Auth ,Jwt,Ldap Auth,Session |     Apikey,Basic      |
|   路由   |                           Headers                            | Header（Strategy-Id） |
| 服务发现 |                              -                               |    Eureka、Consul     |
| 流量控制 | Rate Limmiting,Response Ratelimiting,Request Size Limiting,Request Termination,Proxy Cache |           -           |
| 熔断降级 |                             支持                             |           -           |
| SSL证书  |                             支持                             |           -           |
|   监控   |                        Datadog,Zipkin                        |           -           |
|   性能   |                              高                              |          高           |
| 负载均衡 |                 支持,Ip,Header,Cookie,weight                 |        Weight         |
|   日志   |    TcpLog，UdpLog,Http Log,File Log,Syslog, Statsd,Loggly    | Prometheus，Graphite  |
| 数据转换 |   Request Transformer,Response Transformer,Correlation Id    |           -           |
|   安全   |            Acl,Cors,IpRestriction,Boot Detection             |           -           |
| 健康检查 |                           同Nginx                            |           -           |
| 灰度发布 |                             支持                             |         支持          |
| 插件支持 |                             lua                              |          go           |
| 合作案例 |               Yahoo，masterCard的全球知名公司                | 电信3巨头，石化集团等 |
| 数据支持 |                           Postgres                           |        Sqlite         |

## 引入网关目标

1. 限流：保证接口的稳定性，重大活动降低服务不可用的几率
2. 降级：确保服务不可用的时候有打底方案
3. 缓存：针对特定接口增加缓存，提高服务的可用性和性能

## 选择Kong的原因

1. 稳定性：基于Nginx，且稳定性有保障
2. 扩展性：lua开发插件相对简单
3. 使用习惯：配置原理同nginx，容易了解和符合使用习惯
4. 性能：性能基本和Nginx相当

## 风险识别

1. 公司缺少postgres的使用运维经验
2. 缺少专门的lua开发人员
3. 没有kong网关的实战经验，突发问题依赖于外部支持

# 服务网关Kong部署

## 方案选择

### 部署方式

1. 容器部署
2. 软件部署

### 部署选择

  使用软件安装部署

1. 公司当前线上业务容器使用较少
2. 当前公司服务器配置很强悍，服务器部署能有效保证服务质量

### 部署架构

1. Keeplive 确保 kong高可用
2. keepLive 确保 Postgres 高可用（做主从同步）

## 前期准备

1. 测试环境 ssl证书准备（确保证书为通用证书）
2. 证书环境 ssl证书准备（确保证书为通用证书）
3. 测试环境域名准备
4. 证书环境域名准备
5. 测试环境服务准备（1台 ）
6. 正式环境服务准备 （3台 2kong做双活，1台db服务）
7. 软件准备，Kong，Postgres,Konga
8. app开发协助测试

## 线上环境部署

1. 测试环境安装部署
2. 测试环境配置
3. 测试环境域名解析
4. app 开发 改造会员接口 协助测试
5. 测试环境测试通过
6. 线上环境部署
7. 线上环境配置
8. 线上环境域名解析
9. 测试包直连线上环境 测试
10. 测试通过
11. 线上环境部署完成
12. app 端会员中心接口改造
13. app 上线

# 服务网关Kong迭代计划

## 用户中心迁移至网关V1

### 目标

> 会用中心 app端的接口都是用新的服务网关，使用效果作为观察对象，为全公司推广做准备

### 实施过程

1. 网关部署完毕后实施
2. app开发调整会员中心接口
3. 测试后上线

### 干系人

| 前端         | 后端 | 测试 |
| ------------ | ---- | ---- |
| 王明，李永强 | 王雪 |      |



### 时间预估

> 2周

## 新增页面缓存插件V2

### 目标

> 针对特定接口 ，实施缓存，提高接口的可用性和性能

### 实施过程

1. 正式环境 redis 实例申请（同业务缓存隔离）
2. 开发lua插件系统
3. 将插件部署到测试环境测试
4. 测试完成，将插件部署到正式环境
5. 网关配置特定接口测试校验
6. 根据需要配置接口缓存

### 时间预估

> 1周

### 干系人

> 耿鸿飞，王雪

## 新增接口异常格式输出V3

### 目标

> 统一接口报错信息，将报错异常隔绝用户，保证服务信息不被泄露。

### 实施过程

1. 场景梳理
2. 报错信息确认
3. lua插件开发
4. 测试环境配置
5. 测试环境测试
6. 插件发布到正式
7. 正式环境配置
8. 正式环境测试校验

### 时间预估

> 1周

### 干系人

> 王明，李永强，王雪，耿鸿飞

## 开发api的鉴权功能功能 V4

### 目标

> 接口级别，针对接口实现鉴权功能

### 实施过程

1. 确认授权方案
2. 开发lua插件
3. app改造
4. 测试环境部署插件
5. 测试环境测试通过
6. 插件部署到正式环境
7. app上线
8. 正式环境配置插件
9. 验收

### 时间预估

> 1周

### 干系人

> 耿鸿飞，王明，李永强，梅锋奎

## 公司推广V5

### 目标

> 将服务网关推到整个app的全部接口

### 实施过程

1. 程思沟通思路
2. 运维组沟通
3. 网关推介会
4. app开发调整会员中心api地址
5. ssl正式添加
6. app会员中心接口验证
7. APP 上线
8. 网关管理账号分发到业务部门
9. 网关配置培训
10. 网关配置完成
11. 原域名解析到网关
12. 上线完成

### 时间预估

> 2周 -- 1月

### 干系人

> 程思，李学建，梅锋奎，耿鸿飞，运维组，王明，李永强

## 测试环境部署V5

### 目标

> 公司测试环境使用网关，做到公司各个环境配置一致

### 实施过程

1. 运维确认配置
2. 测试环境网关部署
3. ssl证书配置
4. 网关配置
5. 域名解析
6. 测试环境同发布系统结合
7. 自动化脚本，同步测试环境的各种网关配置
8. 测试开发环境联调
9. 网关交接到运维组

### 时间预估

> 3周 - 2月

### 干系人

> 运维组，耿鸿飞





